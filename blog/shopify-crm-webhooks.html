<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify + CRM : Intégration webhooks réussie - Klyon</title>
    <meta name="description" content="Guide technique complet de l'intégration Shopify-CRM avec webhooks JSON, synchronisation temps réel et gestion des erreurs.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="../minilogo.jpg">
    
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .blog-article {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.8;
        }
        
        .blog-article h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .blog-article .meta {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-secondary);
        }
        
        .blog-article .meta span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            color: var(--accent-color);
            transform: translateX(-5px);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="../index.html">
                    <img src="../logo.jpg" alt="Klyon Logo" class="logo-img">
                </a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="../index.html#accueil" class="nav-link">Accueil</a>
                </li>
                <li class="nav-item">
                    <a href="../index.html#services" class="nav-link">Services</a>
                </li>
                <li class="nav-item">
                    <a href="../index.html#competences" class="nav-link">Compétences</a>
                </li>
                <li class="nav-item">
                    <a href="../index.html#apropos" class="nav-link">À propos</a>
                </li>
                <li class="nav-item">
                    <a href="../index.html#projets" class="nav-link">Projets</a>
                </li>
                <li class="nav-item">
                    <a href="../index.html#blog" class="nav-link">Blog</a>
                </li>
                <li class="nav-item">
                    <a href="../index.html#contact" class="nav-link">Contact</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="blog-article">
        <a href="../index.html#blog" class="back-link">
            <i class="fas fa-arrow-left"></i> Retour au blog
        </a>
        
        <h1>Shopify + CRM : Intégration webhooks réussie</h1>
        
        <div class="meta">
            <span><i class="fas fa-calendar"></i> 28 Août 2024</span>
            <span><i class="fas fa-clock"></i> 6 min de lecture</span>
            <span><i class="fas fa-tag"></i> E-commerce</span>
        </div>
        
        <p>Guide technique complet de l'intégration Shopify-CRM que j'ai développée. Webhooks JSON, synchronisation temps réel et gestion des erreurs. Code Python inclus.</p>
        
        <h2>Le projet : Synchronisation automatique</h2>
        
        <p><strong>Client :</strong> Boutique e-commerce (Marseille)</p>
        <p><strong>Problème :</strong> Saisie manuelle des commandes Shopify dans le CRM</p>
        <p><strong>Solution :</strong> Webhooks automatiques + API REST</p>
        
        <h2>Architecture de l'intégration</h2>
        
        <div class="code-block">
            <pre><code># Structure du projet
shopify-crm-integration/
├── app.py                 # Application Flask principale
├── webhooks.py           # Gestion des webhooks Shopify
├── crm_client.py         # Client API pour le CRM
├── models.py             # Modèles de données
├── config.py             # Configuration
└── requirements.txt      # Dépendances Python</code></pre>
        </div>
        
        <!-- Paywall Overlay -->
        <div id="paywall-overlay" class="paywall-overlay">
            <div class="paywall-content">
                <div class="paywall-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h3>Article Premium</h3>
                <p>Cet article contient du code Python complet pour l'intégration Shopify-CRM, des techniques de webhooks et de gestion d'erreurs.</p>
                
                <div class="paywall-benefits">
                    <h4>Ce que vous découvrirez :</h4>
                    <ul>
                        <li><i class="fas fa-check"></i> Code Python complet pour webhooks</li>
                        <li><i class="fas fa-check"></i> Gestion des erreurs et retry logic</li>
                        <li><i class="fas fa-check"></i> Intégration API REST</li>
                        <li><i class="fas fa-check"></i> Monitoring et logs avancés</li>
                        <li><i class="fas fa-check"></i> Sécurité et validation HMAC</li>
                        <li><i class="fas fa-check"></i> Architecture modulaire</li>
                    </ul>
                </div>
                
                <div class="paywall-cta">
                    <a href="../index.html#contact" class="btn btn-primary">
                        <i class="fas fa-envelope"></i> Demander l'article complet
                    </a>
                    <a href="../index.html#competences" class="btn btn-secondary">
                        <i class="fas fa-code"></i> Voir mes compétences
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Premium Content (Blurred) -->
        <div id="premium-content" class="premium-content">
        
        <h2>Configuration des webhooks Shopify</h2>
        
        <div class="code-block">
            <pre><code># Configuration des webhooks dans Shopify Admin
webhooks = [
    {
        "topic": "orders/create",
        "address": "https://votre-domaine.com/webhook/order-created",
        "format": "json"
    },
    {
        "topic": "orders/updated", 
        "address": "https://votre-domaine.com/webhook/order-updated",
        "format": "json"
    },
    {
        "topic": "orders/paid",
        "address": "https://votre-domaine.com/webhook/order-paid", 
        "format": "json"
    }
]</code></pre>
        </div>
        
        <h2>Gestionnaire de webhooks Flask</h2>
        
        <div class="code-block">
            <pre><code>from flask import Flask, request, jsonify
import hmac
import hashlib
import json
from crm_client import CRMClient

app = Flask(__name__)

@app.route('/webhook/order-created', methods=['POST'])
def handle_order_created():
    # Vérification de l'authenticité du webhook
    if not verify_webhook(request):
        return jsonify({'error': 'Unauthorized'}), 401
    
    try:
        order_data = request.get_json()
        
        # Traitement de la commande
        processed_order = process_shopify_order(order_data)
        
        # Envoi vers le CRM
        crm_client = CRMClient()
        result = crm_client.create_order(processed_order)
        
        if result['success']:
            return jsonify({'status': 'success', 'crm_id': result['id']})
        else:
            return jsonify({'error': result['error']}), 500
            
    except Exception as e:
        return jsonify({'error': str(e)}), 500

def verify_webhook(request):
    """Vérification de l'authenticité du webhook Shopify"""
    hmac_header = request.headers.get('X-Shopify-Hmac-Sha256')
    calculated_hmac = hmac.new(
        WEBHOOK_SECRET.encode('utf-8'),
        request.get_data(),
        hashlib.sha256
    ).hexdigest()
    
    return hmac.compare_digest(calculated_hmac, hmac_header)</code></pre>
        </div>
        
        <h2>Transformation des données Shopify</h2>
        
        <div class="code-block">
            <pre><code>def process_shopify_order(shopify_order):
    """Transforme une commande Shopify en format CRM"""
    
    # Extraction des informations client
    customer = shopify_order.get('customer', {})
    billing_address = shopify_order.get('billing_address', {})
    
    # Calcul du total
    total_price = float(shopify_order['total_price'])
    tax_amount = float(shopify_order.get('total_tax', 0))
    
    # Formatage pour le CRM
    crm_order = {
        'external_id': shopify_order['id'],
        'order_number': shopify_order['name'],
        'customer': {
            'email': customer.get('email'),
            'first_name': customer.get('first_name'),
            'last_name': customer.get('last_name'),
            'phone': customer.get('phone'),
            'address': {
                'street': billing_address.get('address1'),
                'city': billing_address.get('city'),
                'zip_code': billing_address.get('zip'),
                'country': billing_address.get('country')
            }
        },
        'items': [],
        'totals': {
            'subtotal': total_price - tax_amount,
            'tax': tax_amount,
            'total': total_price
        },
        'status': map_order_status(shopify_order['fulfillment_status']),
        'created_at': shopify_order['created_at']
    }
    
    # Traitement des articles
    for line_item in shopify_order.get('line_items', []):
        crm_order['items'].append({
            'product_id': line_item['product_id'],
            'variant_id': line_item['variant_id'],
            'title': line_item['title'],
            'quantity': line_item['quantity'],
            'price': float(line_item['price'])
        })
    
    return crm_order

def map_order_status(shopify_status):
    """Mappe les statuts Shopify vers le CRM"""
    status_mapping = {
        None: 'pending',
        'fulfilled': 'completed',
        'partial': 'processing',
        'restocked': 'cancelled'
    }
    return status_mapping.get(shopify_status, 'pending')</code></pre>
        </div>
        
        <h2>Client API pour le CRM</h2>
        
        <div class="code-block">
            <pre><code>import requests
import json
from datetime import datetime

class CRMClient:
    def __init__(self):
        self.base_url = CRM_API_URL
        self.api_key = CRM_API_KEY
        self.headers = {
            'Authorization': f'Bearer {self.api_key}',
            'Content-Type': 'application/json'
        }
    
    def create_order(self, order_data):
        """Crée une commande dans le CRM"""
        try:
            response = requests.post(
                f"{self.base_url}/api/orders",
                headers=self.headers,
                json=order_data,
                timeout=30
            )
            
            if response.status_code == 201:
                return {
                    'success': True,
                    'id': response.json().get('id'),
                    'message': 'Commande créée avec succès'
                }
            else:
                return {
                    'success': False,
                    'error': f'Erreur CRM: {response.status_code} - {response.text}'
                }
                
        except requests.exceptions.Timeout:
            return {
                'success': False,
                'error': 'Timeout - Le CRM ne répond pas'
            }
        except Exception as e:
            return {
                'success': False,
                'error': f'Erreur de connexion: {str(e)}'
            }
    
    def update_order(self, order_id, update_data):
        """Met à jour une commande existante"""
        try:
            response = requests.put(
                f"{self.base_url}/api/orders/{order_id}",
                headers=self.headers,
                json=update_data,
                timeout=30
            )
            
            return response.status_code == 200
            
        except Exception as e:
            print(f"Erreur mise à jour commande: {e}")
            return False</code></pre>
        </div>
        
        <h2>Gestion des erreurs et retry</h2>
        
        <div class="code-block">
            <pre><code>import time
from functools import wraps

def retry_on_failure(max_retries=3, delay=1):
    """Décorateur pour retry automatique"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(max_retries):
                try:
                    result = func(*args, **kwargs)
                    if result.get('success'):
                        return result
                except Exception as e:
                    if attempt == max_retries - 1:
                        return {
                            'success': False,
                            'error': f'Échec après {max_retries} tentatives: {str(e)}'
                        }
                    time.sleep(delay * (2 ** attempt))  # Backoff exponentiel
            return {'success': False, 'error': 'Max retries atteint'}
        return wrapper
    return decorator

@retry_on_failure(max_retries=3, delay=2)
def sync_order_to_crm(order_data):
    """Synchronise une commande avec retry automatique"""
    crm_client = CRMClient()
    return crm_client.create_order(order_data)</code></pre>
        </div>
        
        <h2>Monitoring et logs</h2>
        
        <div class="code-block">
            <pre><code>import logging
from datetime import datetime

# Configuration des logs
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('shopify_crm.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

def log_webhook_event(event_type, order_id, status, details=None):
    """Log des événements webhook"""
    log_data = {
        'timestamp': datetime.now().isoformat(),
        'event_type': event_type,
        'order_id': order_id,
        'status': status,
        'details': details
    }
    
    logger.info(f"Webhook {event_type}: {json.dumps(log_data)}")

# Utilisation dans les webhooks
@app.route('/webhook/order-created', methods=['POST'])
def handle_order_created():
    order_data = request.get_json()
    order_id = order_data.get('id')
    
    try:
        # ... traitement ...
        log_webhook_event('order_created', order_id, 'success')
        return jsonify({'status': 'success'})
    except Exception as e:
        log_webhook_event('order_created', order_id, 'error', str(e))
        return jsonify({'error': str(e)}), 500</code></pre>
        </div>
        
        <h2>Résultats obtenus</h2>
        
        <ul>
            <li>⚡ <strong>Synchronisation temps réel</strong> : Commandes dans le CRM en < 5 secondes</li>
            <li>🎯 <strong>99.8% de fiabilité</strong> : Système de retry automatique</li>
            <li>📊 <strong>Monitoring complet</strong> : Logs détaillés de tous les événements</li>
            <li>🔄 <strong>Bidirectionnel</strong> : Mise à jour des statuts dans les deux sens</li>
        </ul>
        
        <h2>Points techniques importants</h2>
        
        <ol>
            <li><strong>Sécurité</strong> : Vérification HMAC des webhooks</li>
            <li><strong>Idempotence</strong> : Éviter les doublons avec external_id</li>
            <li><strong>Retry logic</strong> : Gestion des pannes temporaires</li>
            <li><strong>Monitoring</strong> : Logs et alertes en cas d'erreur</li>
        </ol>
        
        <div class="cta-section">
            <h3>🚀 Besoin d'intégrer vos outils e-commerce ?</h3>
            <p>Chaque intégration a ses spécificités. Contactez-moi pour une solution sur-mesure adaptée à votre stack technique.</p>
            <a href="../index.html#contact" class="btn">Discuter de votre projet</a>
        </div>
        </div> <!-- End premium-content -->
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Klyon</h3>
                    <p>Votre partenaire informatique dans le Sud de la France</p>
                </div>
                <div class="footer-section">
                    <h4>Services</h4>
                    <ul>
                        <li><a href="../index.html#services">Support Informatique</a></li>
                        <li><a href="../index.html#services">Développement Sur-Mesure</a></li>
                        <li><a href="../index.html#services">Intelligence Artificielle</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <ul>
                        <li><a href="mailto:klyonme@gmail.com">klyonme@gmail.com</a></li>
                        <li><a href="tel:+33766980342">07 66 98 03 42</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Klyon. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <script src="../script.js"></script>
    
    <!-- Paywall Styles -->
    <style>
        .paywall-overlay {
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
            color: white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: pulse 2s infinite;
        }
        
        .paywall-content {
            position: relative;
            z-index: 2;
        }
        
        .paywall-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: bounce 2s infinite;
        }
        
        .paywall-benefits {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: left;
        }
        
        .paywall-benefits ul {
            list-style: none;
            padding: 0;
        }
        
        .paywall-benefits li {
            display: flex;
            align-items: center;
            margin: 0.8rem 0;
            color: rgba(255,255,255,0.9);
        }
        
        .paywall-benefits i {
            color: #4ade80;
            margin-right: 0.8rem;
            font-size: 1.2rem;
        }
        
        .paywall-cta {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }
        
        .btn-primary, .btn-secondary {
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: white;
            color: #667eea;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .premium-content {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
            position: relative;
        }
        
        .premium-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));
            z-index: 1;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        @media (max-width: 768px) {
            .paywall-cta {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-primary, .btn-secondary {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
    
    <!-- Paywall Protection Script -->
    <script>
        // Protection contre l'inspection
        (function() {
            'use strict';
            
            // Détection des DevTools
            let devtools = {open: false, orientation: null};
            const threshold = 160;
            
            setInterval(function() {
                if (window.outerHeight - window.innerHeight > threshold || 
                    window.outerWidth - window.innerWidth > threshold) {
                    if (!devtools.open) {
                        devtools.open = true;
                        console.clear();
                        console.log('%c🚫 Accès refusé', 'color: #ff0000; font-size: 20px; font-weight: bold;');
                        console.log('%cLe contenu premium est protégé', 'color: #ff0000; font-size: 14px;');
                        console.log('%cContactez-moi pour accéder à l\'article complet', 'color: #ff0000; font-size: 12px;');
                    }
                } else {
                    devtools.open = false;
                }
            }, 500);
            
            // Blocage des interactions sur le contenu premium
            const premiumContent = document.getElementById('premium-content');
            if (premiumContent) {
                // Bloquer la sélection
                premiumContent.addEventListener('selectstart', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                // Bloquer le clic droit
                premiumContent.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                // Bloquer les raccourcis clavier
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'F12' || 
                        (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
                        (e.ctrlKey && e.key === 'U')) {
                        e.preventDefault();
                        console.log('%c🚫 Accès refusé - Contenu protégé', 'color: #ff0000; font-size: 16px; font-weight: bold;');
                        return false;
                    }
                });
                
                // Bloquer la copie
                premiumContent.addEventListener('copy', function(e) {
                    e.preventDefault();
                    return false;
                });
            }
            
            // Animation du paywall
            const paywallOverlay = document.getElementById('paywall-overlay');
            if (paywallOverlay) {
                setInterval(function() {
                    paywallOverlay.style.boxShadow = '0 20px 40px rgba(102,126,234,0.3)';
                    setTimeout(function() {
                        paywallOverlay.style.boxShadow = '0 20px 40px rgba(0,0,0,0.1)';
                    }, 1000);
                }, 3000);
            }
            
            // Tracking des clics sur les boutons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.paywall-cta a')) {
                    // Google Analytics tracking (si disponible)
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'paywall_click', {
                            'event_category': 'engagement',
                            'event_label': 'shopify_article'
                        });
                    }
                }
            });
        })();
    </script>
</body>
</html>
